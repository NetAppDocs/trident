---
sidebar: sidebar
permalink: trident-use/ontap-san-examples.html
keywords: map backends, storage classes, trident backend, ontap san, ontap san economy, options, storageclasses, fsx, metrocluster
summary: Learn about how to create and use ONTAP SAN drivers with your Astra Trident installation. This section provides backend configuration examples and details about how to map backends to StorageClasses.
---

= ONTAP SAN configuration options and examples
:hardbreaks:
:icons: font
:imagesdir: ../media/

[.lead]
Learn how to create and use ONTAP SAN drivers with your Astra Trident installation. This section provides backend configuration examples and details for mapping backends to StorageClasses.

== Backend configuration options

See the following table for the backend configuration options:

[cols="1,3,2",options="header"]
|===
|Parameter |Description |Default
|`version` | |Always 1

|`storageDriverName` | Name of the storage driver |`ontap-nas`, `ontap-nas-economy`, `ontap-nas-flexgroup`, `ontap-san`, `ontap-san-economy`

|`backendName`  |Custom name or the storage backend |Driver name + "_" + dataLIF

|`managementLIF` |IP address of a cluster or SVM management LIF. 

A fully-qualified domain name (FQDN) can be specified.

Can be set to use IPv6 addresses if Astra Trident was installed using the IPv6 flag. IPv6 addresses must be defined in square brackets, such as `[28e8:d9fb:a825:b7bf:69a8:d02f:9e7b:3555]`.  

For seamless MetroCluster switchover, see the <<mcc-best>>.

|“10.0.0.1”, “[2001:1234:abcd::fefe]”

|`dataLIF` |IP address of protocol LIF. 

*Do not specify for iSCSI.* Astra Trident uses link:https://docs.netapp.com/us-en/ontap/san-admin/selective-lun-map-concept.html[ONTAP Selective LUN Map^] to discover the iSCI LIFs needed to establish a multi path session. A warning is generated if `dataLIF` is explicitly defined. 

*Omit for Metrocluster.* See the <<mcc-best>>.

|Derived by the SVM

|`svm` |Storage virtual machine to use 

*Omit for Metrocluster.* See the <<mcc-best>>.

|Derived if an SVM `managementLIF` is specified

|`useCHAP` |Use CHAP to authenticate iSCSI for ONTAP SAN drivers [Boolean]. 

Set to `true` for Astra Trident to configure and use bidirectional CHAP as the default authentication for the SVM given in the backend. Refer to link:ontap-san-prep.html[Prepare to configure backend with ONTAP SAN drivers] for details.

|`false`

|`chapInitiatorSecret` |CHAP initiator secret. Required if `useCHAP=true` |""

|`labels` |Set of arbitrary JSON-formatted labels to apply on volumes |""

|`chapTargetInitiatorSecret` |CHAP target initiator secret. Required if `useCHAP=true` |""

|`chapUsername` |Inbound username. Required if `useCHAP=true` |""

|`chapTargetUsername` |Target username. Required if `useCHAP=true` |""

|`clientCertificate` |Base64-encoded value of client certificate. Used for certificate-based auth |""

|`clientPrivateKey` |Base64-encoded value of client private key. Used for certificate-based auth |""

|`trustedCACertificate` |Base64-encoded value of trusted CA certificate. Optional. Used for certificate-based authentication. |""

|`username` |Username needed to communicate with the ONTAP cluster. Used for credential-based authentication. |""

|`password` |Password needed to communicate with the ONTAP cluster. Used for credential-based authentication. |""

|`svm` |Storage virtual machine to use |Derived if an SVM `managementLIF` is specified

|`storagePrefix` |Prefix used when provisioning new volumes in the SVM. 

Cannot be modified later. To update this parameter, you will need to create a new backend.|`trident`

|`limitAggregateUsage` |Fail provisioning if usage is above this percentage. 

If you are using an Amazon FSx for NetApp ONTAP backend, do not specify  `limitAggregateUsage`. The provided `fsxadmin` and `vsadmin` do not contain the permissions required to retrieve aggregate usage and limit it using Astra Trident.|"" (not enforced by default)

|`limitVolumeSize` |Fail provisioning if requested volume size is above this value. 

Also restricts the maximum size of the volumes it manages for qtrees and LUNs.
|""  (not enforced by default)

|`lunsPerFlexvol` |Maximum LUNs per Flexvol, must be in range [50, 200] |`100`

|`debugTraceFlags` |Debug flags to use when troubleshooting. Example, {"api":false, "method":true} 

Do not use unless you are troubleshooting and require a detailed log dump.|`null`

|`useREST` |Boolean parameter to use ONTAP REST APIs.

`useREST`  When set to `true`, Astra Trident will use ONTAP REST APIs to communicate with the backend; when set to `false`, Astra Trident will use ONTAP ZAPI calls to communicate with the backend. This feature requires ONTAP 9.11.1 and later. In addition, the ONTAP login role used must have access to the `ontap` application. This is satisfied by the pre-defined `vsadmin` and `cluster-admin` roles. Beginning with the Astra Trident 24.06 release and ONTAP 9.15.1 or later, `userREST` is set to `true` by default; change `useREST` to `false` to use ONTAP ZAPI calls.

`useREST` is fully qualified for NVMe/TCP. |`true` for ONTAP 9.15.1 or later, otherwise `false`.

|`sanType` |Use to select `iscsi` for iSCSI or `nvme` for NVMe/TCP. | `iscsi` if blank

|`formatOptions`
a| Use `formatOptions` to specify command line arguments for the `mkfs` command, which will be applied whenever a volume is formatted. This allows you to format the volume according to your preferences. Ensure that you specify the appropriate formatOptions with the `mkfs` command without the device path.
*Example*: `-E nodiscard,lazy_itable_init=1 -O uninit_bg -m 0` 


*Supported for `ontap-san` and `ontap-san-economy` drivers only.* 
a|

|===

=== Recommendations for using formatOptions

==== Recommended formatOptions

Trident recommends the following options could expedite the formatting process:

*Common to all (xfs, ext3, ext4):*
*-K:*

Formatting of XFS/EXT3/EXT4 on a disk of large size (e.g. 8 TB) using mkfs takes 15 minutes or more. It is low because mkfs discards (clears) all blocks in the format process. Even if file system has deleted its files, SSD needs update on a block-free event from the file system. Upon receiving TRIM event, SSD marks the block free in its block table.

This is recommended only when you are sure that the disk contains blocks that are already zeroed out before or otherwise willing to take the performance hit later.

*EXT3/ EXT4:*
`lazy_itable_init[= <0 to disable, 1 to enable>]`

Find more information about this flag link:https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=bfff68738f1cb5c93dab1114634cea02aae9e7ba[here].

If enabled and the `uninit_bg` feature is enabled, the inode table will not be fully initialized by mke2fs. This speeds up filesystem initialization noticeably, but it requires the kernel to finish initializing the filesystem in the background when the filesystem is first mounted. If the option value is omitted, it defaults to 1 to enable lazy inode table initialization.

Already enabled by default(2.6.37+), but if you can wait for the initialization and do not want to offload this process to the `ext4lazyinit` kernel thread, you can set `lazy_itable_init=0`. Or, if you want the thread to have more priority to the specific file system initialization request, then you can set `init_itable=0` (default is 10), during mounting.

*EXT4:*
`uninit_bg:`

Create a filesystem without initializing all of the block groups. This feature also enables checksums and `highest-inode-used` statistics in each blockgroup. This feature can speed up filesystem creation time noticeably (if lazy_itable_init is enabled), and can also reduce e2fsck time dramatically. It is only supported by the ext4 filesystem in Linux Kernels that are either equal or greater than 2.6.28.

*There are other options too which can save the time during formatting:*

*sparse_super:* Create a filesystem with fewer superblock backup copies (saves space on large filesystems).
*large_file:* Filesystem can contain files that are greater than 2GB.  (Modern kernels set this feature  automatically when a file greater than 2GB is created.)
*-m 0:* Only says not to reserve 5% for root, which is acceptable for a data (not boot/root) filesystem.

*stride=stride-size:* Configure the filesystem for a RAID array with stride-size filesystem blocks. This is the number of blocks read or written to disk before moving to the next disk, which is sometimes referred to as the chunk size. This mostly affects placement of filesystem metadata like bitmaps at mke2fs time to avoid placing them on a single disk, which can hurt performance. It may also be used by the block allocator.

NOTE: Must be used only if you know the stride-size beforehand.

*stripe-width=stripe-width:* Configure the filesystem for a RAID array with stripe-width filesystem blocks per stripe. This is typically stride-size * N, where N is the number of data-bearing disks in the RAID (e.g. for RAID 5 there is one parity disk, so N will be the number of disks in the array minus 1). This allows the block allocator to prevent read-modify-write of the parity in a RAID stripe if possible when the data is written

NOTE: Must be used only if you know the RAID that is being used. Generally in ONTAP, RAID 5 is used.

==== Not Recommended Options:

Trident does not recommend using the following options:

*-E test_fs:* Sets a flag in the filesystem superblock indicating that it may be mounted using experimental kernel.

*-F:* Forces mkfs to create a filesystem, even if the specified device is not a partition on a block special device, or if other parameters do not make sense.

*-g blocks-per-group:* Specifies the number of blocks in a block group. There is generally no reason to ever set this parameter because the default is optimal for the filesystem.
*-n:* Causes mkfs to not actually create a filesystem, but display what it would do if it were to create a filesystem.

== Backend configuration options for provisioning volumes

You can control default provisioning using these options in the `defaults` section of the configuration. For an example, see the configuration examples below.

[cols="1,3,2",options="header"]
|===
|Parameter |Description |Default
|`spaceAllocation` |Space-allocation for LUNs |"true"

|`spaceReserve` |Space reservation mode; "none" (thin) or "volume" (thick) |"none"

|`snapshotPolicy` |Snapshot policy to use |"none"

|`qosPolicy` |QoS policy group to assign for volumes created. Choose one of qosPolicy or adaptiveQosPolicy per storage pool/backend. 

Using QoS policy groups with Astra Trident requires ONTAP 9.8 or later. We recommend using a non-shared QoS policy group and ensuring the policy group is applied to each constituent individually. A shared QoS policy group will enforce the ceiling for the total throughput of all workloads. |""

|`adaptiveQosPolicy` |Adaptive QoS policy group to assign for volumes created. Choose one of qosPolicy or adaptiveQosPolicy per storage pool/backend |""

|`snapshotReserve` |Percentage of volume reserved for snapshots	|"0" if `snapshotPolicy` is "none", otherwise ""

|`splitOnClone` |Split a clone from its parent upon creation |"false"

|`encryption` |Enable NetApp Volume Encryption (NVE) on the new volume; defaults to `false`. NVE must be licensed and enabled on the cluster to use this option. 

If NAE is enabled on the backend, any volume provisioned in Astra Trident will be NAE enabled. 

For more information, refer to: link:../trident-reco/security-reco.html[How Astra Trident works with NVE and NAE]. |"false"

|`luksEncryption` | Enable LUKS encryption. Refer to link:../trident-reco/security-luks.html[Use Linux Unified Key Setup (LUKS)]. 

LUKS encryption is not supported for NVMe/TCP.| ""

|`securityStyle` |Security style for new volumes |`unix`

|`tieringPolicy` |Tiering policy to use	"none" |"snapshot-only" for pre-ONTAP 9.5 SVM-DR configuration

|`nameTemplate` | Template to create custom volume names.

|""

|`limitVolumePoolSize` |Maximum requestable FlexVol size when using LUNs in ontap-san-economy backend.

| "" (not enforced by default)

|===



=== Volume provisioning examples
Here's an example with defaults defined:

----
---
version: 1
storageDriverName: ontap-san
managementLIF: 10.0.0.1
svm: trident_svm
username: admin
password: <password>
labels:
  k8scluster: dev2
  backend: dev2-sanbackend
storagePrefix: alternate-trident
debugTraceFlags:
  api: false
  method: true
defaults:
  spaceReserve: volume
  qosPolicy: standard
  spaceAllocation: 'false'
  snapshotPolicy: default
  snapshotReserve: '10'

----

NOTE: For all volumes created using the `ontap-san` driver, Astra Trident adds an extra 10 percent capacity to the FlexVol to accommodate the LUN metadata. The LUN will be provisioned with the exact size that the user requests in the PVC. Astra Trident adds 10 percent to the FlexVol (shows as Available size in ONTAP). Users will now get the amount of usable capacity they requested. This change also prevents LUNs from becoming read-only unless the available space is fully utilized. This does not apply to ontap-san-economy.

For backends that define `snapshotReserve`, Astra Trident calculates the size of volumes as follows:
----
Total volume size = [(PVC requested size) / (1 - (snapshotReserve percentage) / 100)] * 1.1
----

The 1.1 is the extra 10 percent Astra Trident adds to the FlexVol to accommodate the LUN metadata. For `snapshotReserve` = 5%, and PVC request = 5GiB, the total volume size is 5.79GiB and the available size is 5.5GiB. The `volume show` command should show results similar to this example:

image::../media/vol-show-san.png[Shows the output of the volume show command.]

Currently, resizing is the only way to use the new calculation for an existing volume.

== Minimal configuration examples

The following examples show basic configurations that leave most parameters to default. This is the easiest way to define a backend.

NOTE: If you are using Amazon FSx on NetApp ONTAP with Astra Trident, we recommend you specify DNS names for LIFs instead of IP addresses.

.ONTAP SAN example
[%collapsible%closed]
====
This is a basic configuration using the `ontap-san` driver.
----
---
version: 1
storageDriverName: ontap-san
managementLIF: 10.0.0.1
svm: svm_iscsi
labels:
  k8scluster: test-cluster-1
  backend: testcluster1-sanbackend
username: vsadmin
password: <password>
----
====

.ONTAP SAN economy example
[%collapsible%closed]
====
----
---
version: 1
storageDriverName: ontap-san-economy
managementLIF: 10.0.0.1
svm: svm_iscsi_eco
username: vsadmin
password: <password>
----
====

[#mcc-best]
. example
[%collapsible%closed]
====
You can configure the backend to avoid having to manually update the backend definition after switchover and switchback during link:../trident-reco/backup.html#svm-replication-and-recovery[SVM replication and recovery]. 

For seamless switchover and switchback, specify the SVM using `managementLIF` and omit the `dataLIF` and `svm` parameters. For example:

----
---
version: 1
storageDriverName: ontap-san
managementLIF: 192.168.1.66
username: vsadmin
password: password
----
====

.Certificate-based authentication example
[%collapsible%closed]
====

In this basic configuration example `clientCertificate`, `clientPrivateKey`, and `trustedCACertificate` (optional, if using trusted CA) are populated in `backend.json` and take the base64-encoded values of the client certificate, private key, and trusted CA certificate, respectively.

----
---
version: 1
storageDriverName: ontap-san
backendName: DefaultSANBackend
managementLIF: 10.0.0.1
svm: svm_iscsi
useCHAP: true
chapInitiatorSecret: cl9qxIm36DKyawxy
chapTargetInitiatorSecret: rqxigXgkesIpwxyz
chapTargetUsername: iJF4heBRT0TCwxyz
chapUsername: uh2aNCLSd6cNwxyz
clientCertificate: ZXR0ZXJwYXB...ICMgJ3BhcGVyc2
clientPrivateKey: vciwKIyAgZG...0cnksIGRlc2NyaX
trustedCACertificate: zcyBbaG...b3Igb3duIGNsYXNz
----
====

.Bidirectional CHAP examples
[%collapsible%closed]
====
These examples create a backend with `useCHAP` set to `true`.

.ONTAP SAN CHAP example
----
---
version: 1
storageDriverName: ontap-san
managementLIF: 10.0.0.1
svm: svm_iscsi
labels:
  k8scluster: test-cluster-1
  backend: testcluster1-sanbackend
useCHAP: true
chapInitiatorSecret: cl9qxIm36DKyawxy
chapTargetInitiatorSecret: rqxigXgkesIpwxyz
chapTargetUsername: iJF4heBRT0TCwxyz
chapUsername: uh2aNCLSd6cNwxyz
username: vsadmin
password: <password>
----

.ONTAP SAN economy CHAP example
----
---
version: 1
storageDriverName: ontap-san-economy
managementLIF: 10.0.0.1
svm: svm_iscsi_eco
useCHAP: true
chapInitiatorSecret: cl9qxIm36DKyawxy
chapTargetInitiatorSecret: rqxigXgkesIpwxyz
chapTargetUsername: iJF4heBRT0TCwxyz
chapUsername: uh2aNCLSd6cNwxyz
username: vsadmin
password: <password>
----
====

.NVMe/TCP example
[%collapsible%closed]
====
You must have an SVM configured with NVMe on your ONTAP backend. This is a basic backend configuration for NVMe/TCP.
----
---
version: 1
backendName: NVMeBackend
storageDriverName: ontap-san
managementLIF: 10.0.0.1
svm: svm_nvme
username: vsadmin
password: password
sanType: nvme
useREST: true
----
====

.Backend configuration example with nameTemplate
[%collapsible%closed]
====

----
---
version: 1
storageDriverName: ontap-san
backendName: ontap-san-backend
managementLIF: <ip address>
svm: svm0
username: <admin>
password: <password>
defaults: {
    "nameTemplate": "{{.volume.Name}}_{{.labels.cluster}}_{{.volume.Namespace}}_{{.volume.RequestName}}"
},
"labels": {"cluster": "ClusterA", "PVC": "{{.volume.Namespace}}_{{.volume.RequestName}}"}
----
====


.formatOptions example for `ontap-san-economy` driver
[%collapsible%closed]
====

----
{
    "version": 1,
    "storageDriverName": "ontap-san-economy",
    "managementLIF": "",
    "svm": "svm1",
    "username": "",
    "password": "!",
    "storagePrefix": "whelk_",
    "debugTraceFlags": {
        "method": true,
        "api": true
    },
    "defaults":{
        "formatOptions": "-E lazy_itable_init=1,nodiscard -b 4096 -G 256"
    }
}
----
====

== Examples of backends with virtual pools

In these sample backend definition files, specific defaults are set for all storage pools, such as `spaceReserve` at none, `spaceAllocation` at false, and `encryption` at false. The virtual pools are defined in the storage section.

Astra Trident sets provisioning labels in the "Comments" field. Comments are set on the FlexVol. Astra Trident copies all labels present on a virtual pool to the storage volume at provisioning. For convenience, storage administrators can define labels per virtual pool and group volumes by label. 

In these examples, some of the storage pools set their own `spaceReserve`, `spaceAllocation`, and `encryption` values, and some pools override the default values.

.ONTAP SAN example
[%collapsible%closed]
====
----
---
version: 1
storageDriverName: ontap-san
managementLIF: 10.0.0.1
svm: svm_iscsi
useCHAP: true
chapInitiatorSecret: cl9qxIm36DKyawxy
chapTargetInitiatorSecret: rqxigXgkesIpwxyz
chapTargetUsername: iJF4heBRT0TCwxyz
chapUsername: uh2aNCLSd6cNwxyz
username: vsadmin
password: <password>
defaults:
  spaceAllocation: 'false'
  encryption: 'false'
  qosPolicy: standard
labels:
  store: san_store
  kubernetes-cluster: prod-cluster-1
region: us_east_1
storage:
- labels:
    protection: gold
    creditpoints: '40000'
  zone: us_east_1a
  defaults:
    spaceAllocation: 'true'
    encryption: 'true'
    adaptiveQosPolicy: adaptive-extreme
- labels:
    protection: silver
    creditpoints: '20000'
  zone: us_east_1b
  defaults:
    spaceAllocation: 'false'
    encryption: 'true'
    qosPolicy: premium
- labels:
    protection: bronze
    creditpoints: '5000'
  zone: us_east_1c
  defaults:
    spaceAllocation: 'true'
    encryption: 'false'
----
====

.ONTAP SAN economy example
[%collapsible%closed]
====
----
---
version: 1
storageDriverName: ontap-san-economy
managementLIF: 10.0.0.1
svm: svm_iscsi_eco
useCHAP: true
chapInitiatorSecret: cl9qxIm36DKyawxy
chapTargetInitiatorSecret: rqxigXgkesIpwxyz
chapTargetUsername: iJF4heBRT0TCwxyz
chapUsername: uh2aNCLSd6cNwxyz
username: vsadmin
password: <password>
defaults:
  spaceAllocation: 'false'
  encryption: 'false'
labels:
  store: san_economy_store
region: us_east_1
storage:
- labels:
    app: oracledb
    cost: '30'
  zone: us_east_1a
  defaults:
    spaceAllocation: 'true'
    encryption: 'true'
- labels:
    app: postgresdb
    cost: '20'
  zone: us_east_1b
  defaults:
    spaceAllocation: 'false'
    encryption: 'true'
- labels:
    app: mysqldb
    cost: '10'
  zone: us_east_1c
  defaults:
    spaceAllocation: 'true'
    encryption: 'false'
- labels:
    department: legal
    creditpoints: '5000'
  zone: us_east_1c
  defaults:
    spaceAllocation: 'true'
    encryption: 'false'
----
====

.NVMe/TCP example
[%collapsible%closed]
====
----
---
version: 1
storageDriverName: ontap-san
sanType: nvme
managementLIF: 10.0.0.1
svm: nvme_svm
username: vsadmin
password: <password>
useREST: true
defaults:
  spaceAllocation: 'false'
  encryption: 'true'
storage:
- labels:
    app: testApp
    cost: '20'
  defaults:
    spaceAllocation: 'false'
    encryption: 'false'
----
====

== Map backends to StorageClasses

The following StorageClass definitions refer to the <<Examples of backends with virtual pools>>. Using the `parameters.selector` field, each StorageClass calls out which virtual pools can be used to host a volume. The volume will have the aspects defined in the chosen virtual pool.

* The `protection-gold` StorageClass will map to the first virtual pool in the `ontap-san` backend. This is the only pool offering gold-level protection.
+
----
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: protection-gold
provisioner: csi.trident.netapp.io
parameters:
  selector: "protection=gold"
  fsType: "ext4"
----

* The `protection-not-gold` StorageClass will map to the second and third virtual pool in `ontap-san` backend. These are the only pools offering a protection level other than gold.
+
----
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: protection-not-gold
provisioner: csi.trident.netapp.io
parameters:
  selector: "protection!=gold"
  fsType: "ext4"
----

* The `app-mysqldb` StorageClass will map to the third virtual pool in `ontap-san-economy` backend. This is the only pool offering storage pool configuration for the mysqldb type app.
+
----
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: app-mysqldb
provisioner: csi.trident.netapp.io
parameters:
  selector: "app=mysqldb"
  fsType: "ext4"
----

* The `protection-silver-creditpoints-20k` StorageClass will map to the second virtual pool in `ontap-san` backend. This is the only pool offering silver-level protection and 20000 creditpoints.
+
----
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: protection-silver-creditpoints-20k
provisioner: csi.trident.netapp.io
parameters:
  selector: "protection=silver; creditpoints=20000"
  fsType: "ext4"
----
* The `creditpoints-5k` StorageClass will map to the third virtual pool in `ontap-san` backend and the fourth virtual pool in the `ontap-san-economy` backend. These are the only pool offerings with 5000 creditpoints.
+
----
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: creditpoints-5k
provisioner: csi.trident.netapp.io
parameters:
  selector: "creditpoints=5000"
  fsType: "ext4"
----
* The `my-test-app-sc` StorageClass will map to the `testAPP` virtual pool in the `ontap-san` driver with `sanType: nvme`. This is the only pool offering `testApp`. 
+
----
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: my-test-app-sc
provisioner: csi.trident.netapp.io
parameters:
  selector: "app=testApp"
  fsType: "ext4"
----

Astra Trident will decide which virtual pool is selected and will ensure the storage requirement is met.