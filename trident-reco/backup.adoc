---
sidebar: sidebar
permalink: trident-reco/backup.html
keywords: data protection, replication, dr, disaster recovery, snapmirror, back up, snapshot, element, volume replication
summary: Learn about data protection and recovery options that NetApp storage platforms provide. Astra Trident can provision volumes that can take advantage of some of these features. You should have a data protection and recovery strategy for each application with a persistence requirement.
---

= Data protection and disaster recovery
:hardbreaks:
:icons: font
:imagesdir: ../media/

[.lead]
Learn about data protection and recovery options that NetApp storage platforms provide. Astra Trident can provision volumes that can take advantage of some of these features. You should have a data protection and recovery strategy for each application with a persistence requirement.

== Astra Trident replication and recovery
You can create a backup to restore Astra Trident in the event of a disaster. 

=== Astra Trident replication
Astra Trident uses Kubernetes CRDs to store and manage its own state and the Kubernetes cluster etcd to store its metadata. 

NOTE: For details on backing up the Kubernetes cluster, refer to link:https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster[Kubernetes: Backing up an etcd cluster^].

// As an example, assume the Kubernetes etcd data files and the certificates are stored on NetApp FlexVolume created outside of Astra Trident. This FlexVolume resides in a storage virtual machine (SVM), which has a SnapMirror SVM disaster recovery (DR) relationship with a destination SVM at the secondary site.

=== Astra Trident recovery
Using Kubernetes CRDs and the Kubernetes cluster etcd snapshot, you can recover Astra Trident.

.Steps
. From the destination SVM, mount the volume which contains the Kubernetes etcd data files and certificates on to the host which will be setup as a master node.

. Copy all required certificates pertaining to the Kubernetes cluster under `/etc/kubernetes/pki` and the etcd member files under `/var/lib/etcd`.

. Create a Kubernetes cluster using `kubeadm init` with the `--ignore-preflight-errors=DirAvailable—​var-lib-etcd` flag. The hostnames used for the Kubernetes nodes should be the same as the source Kubernetes cluster.

. Run `kubectl get crd` to verify all Trident custom resources have come up and retrieve the Trident objects to verify all data is available.

NOTE: After the Kubernetes cluster is set up on the destination side, all the pods are started and the containerized applications should run without issue.

== SVM replication and recovery
Astra Trident cannot configure replication relationships, so the storage administrator can use https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-concepts/GUID-8B187484-883D-4BB4-A1BC-35AC278BF4DC.html[SnapMirror^] to replicate a complete SVM, which can include its configuration settings and volumes. In the event of a disaster, you can activate the SnapMirror destination SVM to start serving data. You can switch back to the primary when systems are restored.

.About this task
Consider the following when using the SnapMirror SVM Replication feature:

* You should create a distinct backend for each SVM with SVM-DR enabled.

* Configure the storage classes to select the replicated backends only when needed. This is important to avoid having volumes which do not need the protection of a replication relationship to be provisioned onto the backends that support SVM-DR.

* Application administrators should understand the additional cost and complexity associated with replicating the data and determine a plan for recovery before leveraging data replication.

=== SVM replication 
Using SnapMirror _policies_, _relationships_, and _relationship transfers_, you can replicate an SVM. SnapMirror allows you to set options to control what to replicate:

* link:https://docs.netapp.com/us-en/ontap/data-protection/replicate-entire-svm-config-task.html[-identity-preserve true^] replicates the entire SVM configuration. 
* link:https://docs.netapp.com/us-en/ontap/data-protection/exclude-lifs-svm-replication-task.html[-discard-configs network^] excludes LIFs and related network settings from the SVM replication.  
* link:https://docs.netapp.com/us-en/ontap/data-protection/exclude-network-name-service-svm-replication-task.html[-identity-preserve false] replicates only the volumes and security configuration.  

Refer to link:https://docs.netapp.com/us-en/ontap/data-protection/snapmirror-svm-replication-workflow-concept.html[ONTAP: SnapMirror SVM replication workflow] to create the SVM replication relationship.

// .Steps

// . Set up peering between the source and destination cluster and SVM.

// . Create the destination SVM by using the `-subtype dp-destination` option.

// . Create a replication job schedule to ensure that replication happens at the required intervals.

// . Create a SnapMirror replication from the destination SVM to the source SVM. Refer to link:https://docs.netapp.com/us-en/ontap/data-protection/snapmirror-svm-replication-workflow-concept.html[ONTAP: SnapMirror SVM replication workflow^] for full details and options. 

// .. Use the `-identity-preserve false` option to replicate only the SVM volumes and RBAC configuration.  
// .. Use the `-identity-preserve true` option to include SVM configuration in the replication. 
// .. Use the `-discard-configs network` option to exclude LIFs and related network settings from the SVM replication. 

// . From the destination SVM, initialize the SnapMirror SVM replication relationship.

image::SVMDR1.PNG[Shows the steps involved in setting up SVM.]

=== SVM recovery using Astra Trident
Astra Trident does not automatically detect SVM failures. Therefore, the administrator should run `tridentctl update backend` to initiate Trident failover to the new backend in the event of a failure.

.Steps

. Cancel all scheduled and ongoing SnapMirror transfers, break the replication relationship, stop the source SVM, and then activate the SnapMirror destination SVM.
. If you specified `-identity-preserve false` or `-discard-config network` when creating your SVM replication,  update the `managementLIF` and `dataLIF` in the backend JSON file. 
. Update all the required backends to reflect the new destination SVM name using:
+
----
./tridentctl update backend <backend-name> -f <backend-json-file> -n <namespace>
----
. For application persistent volumes, if you specified `-identify-preserve false`, you must bounce all application pods. 
+
NOTE: If you specified `-identify-preserve true`, all volumes provisioned by Astra Trident start serving data when the destination SVM is activated.
. If data LIFs were changed, ensure the worker nodes can access and mount volumes using the new data LIF IPs. 

== Volume replication and recovery
You can replicate volumes using SnapMirror and recover them using Astra Trident. 

=== Volume replication using SnapMirror
SnapMirror creates a replica, or mirror, of your working data in secondary storage from which you can continue to serve data in the event of a catastrophe at the primary site. Refer to link:https://docs.netapp.com/us-en/ontap/data-protection/snapmirror-disaster-recovery-concept.html[Asynchronous SnapMirror disaster recovery basics^] for details. 

SnapMirror offers two methods for replicating volumes: 

* Beginning in ONTAP 9.5, link:https://docs.netapp.com/us-en/ontap/data-protection/create-replication-relationship-one-step-task.html[snapmirror protect^] configures a replication relationship in one step. 
* Optionally, you can link:https://docs.netapp.com/us-en/ontap/data-protection/create-destination-volume-task.html[configure the relationship one step at a time^].

// .Steps 
// . Set up peering between the clusters in which the volumes reside and the SVMs that serve data from the volumes.
// . Create a SnapMirror policy, which controls the behavior of the relationship and specifies the configuration attributes for that relationship.

// . Create a SnapMirror relationship between the destination volume and the source volume by using the link:https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-cmpr-970/snapmirror__create.html[`snapmirror create` command^] and assign the appropriate SnapMirror policy.

// . After the SnapMirror relationship is created, initialize the relationship so that a baseline transfer from the source volume to the destination volume is completed.
// +
// image::SM1.PNG[Shows the SnapMirror volume replication setup.]

=== Volume recovery using Astra Trident
You can recover a SnapMirror volume using Astra Trident.

.Steps

. Cancel all scheduled and ongoing SnapMirror transfers and break the replication relationship between the destination and source volumes so the destination volume becomes read/write. 
. Delete pods which were consuming PVC bound to volumes on the source SVM.
. Import the required volumes as a PV bound to a new PVC using link:trident-use/vol-import.adoc[volume import].
+
NOTE: Import is not supported on `ontap-nas-economy` or `ontap-san-economy` drivers.
. Redeploy the application deployments with the newly created PVCs.
. Delete old PVCs and PV from the Kubernetes cluster.
. Redeploy the the application pods to mount the newly created PVCs.

== Recover volume data using snapshots

Astra Trident snapshots are supported using `ontap-nas`, `ontap-nas-flexgroup`, `ontap-san`, `ontap-san-economy`, `solidfire-san`, `gcp-cvs`, and `azure-netapp-files` drivers. Refer to link:trident-use/vol-snapshots.adoc[Work with snapshots] for details.

Refer to link:https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-concepts/GUID-A9A2F347-3E05-4F80-9E9C-CEF8F0A2F8E1.html[ONTAP: Snapshot copies^] for more information on ONTAP Snapshots.
