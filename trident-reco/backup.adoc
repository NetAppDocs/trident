---
sidebar: sidebar
permalink: trident-reco/backup.html
keywords: data protection, replication, dr, disaster recovery, snapmirror, back up, snapshot, element, volume replication
summary: Learn about data protection and recoverability options that NetApp storage platforms provide. Astra Trident can provision volumes that can take advantage of some of these features. You should have a data protection and recovery strategy for each application with a persistence requirement.
---

= Data protection and disaster recovery
:hardbreaks:
:icons: font
:imagesdir: ../media/

[.lead]
Learn about data protection and recoverability options that NetApp storage platforms provide. Astra Trident can provision volumes that can take advantage of some of these features. You should have a data protection and recovery strategy for each application with a persistence requirement.

== Astra Trident replication and recovery
Astra Trident uses Kubernetes CRDs to store and manage its own state and the Kubernetes cluster etcd to store its metadata. For example, assume the Kubernetes etcd data files and the certificates are stored on NetApp FlexVolume. This FlexVolume resides in a storage virtual machine (SVM), which has a SnapMirror SVM disaster recovery (DR) relationship with a destination SVM at the secondary site.

Refer to link:https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster[Kubernetes: Backing up an etcd cluster^] for details on creating an etcd snapshot. 

The following steps describe how to recover a single master Kubernetes cluster with Astra Trident. 

.Steps
. Activate the SnapMirror destination SVM. Cancel scheduled and ongoing SnapMirror transfers, break the replication relationship, stop the source SVM, and start the destination SVM.

. From the destination SVM, mount the volume which contains the Kubernetes etcd data files and certificates on to the host which will be setup as a master node.

. Copy all required certificates pertaining to the Kubernetes cluster under `/etc/kubernetes/pki` and the etcd member files under `/var/lib/etcd`.

. Create a Kubernetes cluster using `kubeadm init` with the `--ignore-preflight-errors=DirAvailable—​var-lib-etcd` flag. The hostnames used for the Kubernetes nodes should be the same as the source Kubernetes cluster.

. Run `kubectl get crd` to verify all Trident custom resources have come up and retrieve the Trident objects to verify all data is available.

. Update the required backends to reflect the new destination SVM name by running: `./tridentctl update backend <backend-name> -f <backend-json-file> -n <namespace>`

NOTE: For application persistent volumes, when the destination SVM is activated, all the volumes provisioned by Trident start serving data. After the Kubernetes cluster is set up on the destination side by using the steps outlined above, all the deployments and pods are started and the containerized applications should run without any issues.

== SnapMirror SVM replication and recovery
Astra Trident cannot configure replication relationships, so the storage administrator can use https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-concepts/GUID-8B187484-883D-4BB4-A1BC-35AC278BF4DC.html[SnapMirror^] to replicate a complete storage virtual machine (SVM), which includes its configuration settings and its volumes. In the event of a disaster, you can activate the SnapMirror destination SVM to start serving data. You can switch back to the primary when the systems are restored.

=== SnapMirror SVM replication 
Consider the following when using the SnapMirror SVM Replication feature:

* You should create a distinct backend for each SVM with SVM-DR enabled.

* Configure the storage classes to select the replicated backends only when needed. This is important to avoid having volumes which do not need the protection of a replication relationship to be provisioned onto the backends that support SVM-DR.

* Application administrators should understand the additional cost and complexity associated with replicating the data and determine a plan for recovery before leveraging data replication.

.Steps

. Set up peering between the source and destination cluster and SVM.

. Create the destination SVM by using the `-subtype dp-destination` option.

. Create a replication job schedule to ensure that replication happens at the required intervals.

. Create a SnapMirror replication from the destination SVM to the source SVM. Refer to link:https://docs.netapp.com/us-en/ontap/data-protection/snapmirror-svm-replication-workflow-concept.html[ONTAP: SnapMirror SVM replication workflow^] for full details and options. 

.. Use the `-identity-preserve false` option to replicate only the SVM volumes and RBAC configuration.  
.. Use the `-identity-preserve true` option to include SVM configuration in the replication. 
.. Use the `-discard-configs network` option to exclude LIFs and related network settings from the SVM replication. 

. From the destination SVM, initialize the SnapMirror SVM replication relationship.
+
image::SVMDR1.PNG[Shows the steps involved in setting up SVM.]

=== SnapMirror SVM recovery
Astra Trident does not automatically detect SVM failures. Therefore, the administrator should run `tridentctl update backend` to initiate Trident failover to the new backend in the event of a failure.

.Steps

. Cancel all scheduled and ongoing SnapMirror transfers, break the replication relationship, stop the source SVM, and then activate the SnapMirror destination SVM.
. Run `kubectl get crd` to verify all Trident custom resources have come up and retrieve the Trident objects to verify all data is available.
. If you specified `-identity-preserve false` or `-discard-config network` when creating your SVM replication,  you will need to update the `managementLIF` and `dataLIF` in the backend JSON file. 
. Update all the required backends to reflect the new destination SVM name using the following command:
+
----
./tridentctl update backend <backend-name> -f <backend-json-file> -n <namespace>
----

[NOTE]
====
* If data LIFs were changed, ensure the worker nodes can access and mount volumes using the new data LIF IPs. 
* For application persistent volumes, when the destination SVM is activated, all the volumes provisioned by Astra Trident start serving data. After the Kubernetes cluster is set up on the destination side by using the steps outlined above, all the deployments and pods are started and the containerized applications should run without any issues.
====

== SnapMirror volume replication and recovery

SnapMirror volume replication enables failover to destination storage from primary storage on a volume level. SnapMirror creates a volume replica, or _mirror_, of the primary storage on the secondary storage by syncing snapshots.

=== Volume replication

.Steps 

. Set up peering between the clusters in which the volumes reside and the SVMs that serve data from the volumes.

. Create a SnapMirror policy, which controls the behavior of the relationship and specifies the configuration attributes for that relationship.

. Create a SnapMirror relationship between the destination volume and the source volume by using the https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-cmpr-970/snapmirror__create.html[`snapmirror create` command^] and assign the appropriate SnapMirror policy.

. After the SnapMirror relationship is created, initialize the relationship so that a baseline transfer from the source volume to the destination volume is completed.
+
image::SM1.PNG[Shows the SnapMirror volume replication setup.]

=== SnapMirror volume recovery 

You can recover a SnapMirror volume using Astra Trident.

.Steps

. Cancel all scheduled and ongoing SnapMirror transfers and break the replication relationship between the destination and source volumes so the destination volume becomes read/write.
. Run the `kubectl get crd` command to verify if all the Trident custom resources have come up and retrieve Trident objects to make sure that all the data is available.
. Modify existing backends and create new backends on Trident. Specify the new management LIF, new SVM name, and password of the destination SVM.

=== Application persistent volumes recovery

SnapMirror destination volumes can be made available for containerized workloads in the event of a disaster.

.Steps

. Cancel all scheduled and ongoing SnapMirror transfers and break the replication relationship between the destination and source volumes so the destination volume becomes read/write. 
. Clean up the deployments which were consuming PVC bound to volumes on the source SVM.
. After the Kubernetes cluster is set up on the destination side by using the steps outlined above, clean up the deployments, PVCs and PV, from the Kubernetes cluster.
. Modify existing backends and create new backends on Trident. Specify the new management LIF, new SVM name, and password of the destination SVM.
. Import the required volumes as a PV bound to a new PVC using the Trident import feature.
+
NOTE: Import is not supported on `ontap-nas-economy` or `ontap-san-economy` drivers.
. Redeploy the application deployments with the newly created PVCs.

== Recover volume data using ONTAP Snapshots

Astra Trident snapshots are supported using `ontap-nas`, `ontap-nas-flexgroup`, `ontap-san`, `ontap-san-economy`, `solidfire-san`, `gcp-cvs`, and `azure-netapp-files` drivers. Refer to link:trident-use/vol-snapshots.adoc[Work with snapshots] for details.

Refer to link:https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-concepts/GUID-A9A2F347-3E05-4F80-9E9C-CEF8F0A2F8E1.html[ONTAP: Snapshot copies^] for more information on ONTAP Snapshots.
